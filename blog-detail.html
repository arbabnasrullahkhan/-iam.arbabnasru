<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- DYNAMIC META TAGS - These will be filled by JavaScript -->
    <title>Blog Post | Arbab Nasrullah</title>
    <meta name="description" content="Insights on design, development, and trading from Arbab Nasrullah.">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="Blog Post | Arbab Nasrullah">
    <meta property="og:description" content="Insights on design, development, and trading from Arbab Nasrullah.">
    <meta property="og:image" content="assets/og-default.jpg"> <!-- A default image -->
    <meta property="og:url" content="">
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Blog Post | Arbab Nasrullah">
    <meta name="twitter:description" content="Insights on design, development, and trading from Arbab Nasrullah.">
    <meta name="twitter:image" content="assets/og-default.jpg"> <!-- A default image -->
    
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root { --bg-color: #030712; --text-color: #f3f4f6; --text-secondary: #9ca3af; --card-bg: rgba(31, 41, 55, 0.5); --border-color: rgba(55, 65, 81, 0.6); --brand-gradient: linear-gradient(90deg, #3B82F6, #8B5CF6); }
        html.light { --bg-color: #f9fafb; --text-color: #111827; --text-secondary: #4b5563; --card-bg: rgba(255, 255, 255, 0.7); --border-color: #e5e7eb; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .glass-effect { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border-color); }
        .brand-gradient-text { background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Styles for intelligently rendered post content */
        .post-content p, .post-content ul, .post-content ol { margin-bottom: 1.5rem; line-height: 1.8; color: var(--text-secondary); }
        .post-content h1, .post-content h2, .post-content h3 { font-weight: 700; margin-top: 2.5rem; margin-bottom: 1rem; color: var(--text-color); }
        .post-content h1 { font-size: 2.25rem; } .post-content h2 { font-size: 1.875rem; } .post-content h3 { font-size: 1.5rem; }
        .post-content a { color: #60a5fa; text-decoration: underline; }
        .post-content strong { color: var(--text-color); }
        .post-content img { max-width: 100%; height: auto; border-radius: 0.75rem; margin: 1.5rem auto; display: block; }
        
        /* NEW: Smart styling for custom buttons created in the editor */
        .post-content a.btn-post {
            display: inline-block; padding: 12px 28px; background-color: var(--text-color); color: var(--bg-color);
            text-decoration: none; font-size: 16px; font-weight: bold; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s ease;
        }
        .post-content a.btn-post:hover { transform: scale(1.05); }

        [x-cloak] { display: none !important; }
        .lightbox { display: none; }
        .lightbox.active { display: flex; }
    </style>
</head>
<body class="w-full">

    <header class="sticky top-0 left-0 w-full z-50 glass-effect">
        <div class="container mx-auto px-5 py-4 grid grid-cols-3 items-center">
            <div class="justify-self-start"><a href="blog.html" class="glass-effect flex items-center gap-2 font-semibold text-sm py-2 px-4 rounded-full hover:border-blue-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg><span>Back</span></a></div>
            <div class="justify-self-center"><a href="home.html" class="text-2xl font-extrabold tracking-tight">AN.</a></div>
            <div class="justify-self-end"><button id="theme-toggle" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors"><svg id="theme-icon-light" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button></div>
        </div>
    </header>
    
    <main class="container mx-auto px-5 pt-24 pb-20">
        <article id="post-detail-container" class="max-w-4xl mx-auto">
            <!-- Loading Skeleton -->
            <div class="animate-pulse">
                <div class="h-8 w-3/4 bg-gray-700/50 rounded mb-4"></div><div class="h-4 w-1/4 bg-gray-700/50 rounded mb-8"></div>
                <div class="h-96 bg-gray-700/50 rounded-xl mb-8"></div><div class="space-y-4"><div class="h-4 bg-gray-700/50 rounded"></div><div class="h-4 bg-gray-700/50 rounded"></div><div class="h-4 w-5/6 bg-gray-700/50 rounded"></div></div>
            </div>
        </article>
    </main>

    <!-- LIGHTBOX MODAL for images -->
    <div id="lightbox" x-data="{ open: false, image: '' }" @open-lightbox.window="open = true; image = $event.detail.image" x-show="open" @keydown.escape.window="open = false" class="lightbox fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4" x-cloak x-transition>
        <button @click="open = false" class="absolute top-4 right-4 text-white text-5xl hover:text-blue-400 transition-colors">×</button>
        <img :src="image" class="max-w-full max-h-full rounded-lg" alt="Full screen gallery image">
    </div>
    
    <footer class="border-t border-[var(--border-color)]">
        <div class="container mx-auto px-5 py-8 text-center text-sm text-[var(--text-secondary)]"><p>© 2024 Arbab Nasrullah. All Rights Reserved.</p></div>
    </footer>
    
    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
 
        document.addEventListener('DOMContentLoaded', () => {
            const postContainer = document.getElementById('post-detail-container');
            
            // --- Helper Functions ---
            function stripHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                return doc.body.textContent || "";
            }

            function injectMetaTags(post, smartDescription) {
                document.querySelector('meta[name="description"]').setAttribute('content', smartDescription);
                document.querySelector('meta[property="og:title"]').setAttribute('content', post.title);
                document.querySelector('meta[property="og:description"]').setAttribute('content', smartDescription);
                document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);
                document.querySelector('meta[name="twitter:title"]').setAttribute('content', post.title);
                document.querySelector('meta[name="twitter:description"]').setAttribute('content', smartDescription);
                if (post.imageUrl) {
                    const imageUrl = `${window.location.origin}/assets/blog/${post.imageUrl}`;
                    document.querySelector('meta[property="og:image"]').setAttribute('content', imageUrl);
                    document.querySelector('meta[name="twitter:image"]').setAttribute('content', imageUrl);
                }
            }

            async function fetchPostDetails() {
                const postId = new URLSearchParams(window.location.search).get('id');
                if (!postId) { postContainer.innerHTML = `<p class="text-center text-red-500">Post ID not found.</p>`; return; }

                try {
                    const docSnap = await getDoc(doc(db, "posts", postId));
                    if (docSnap.exists()) {
                        const post = docSnap.data();
                        
                        // --- 1. Create Smart Description & Inject Meta Tags ---
                        const smartDescription = stripHtml(post.content).substring(0, 155).trim() + '...';
                        injectMetaTags(post, smartDescription);
                        document.title = `${post.title} | Arbab Nasrullah`;
                        
                        // --- 2. Extract Images for Gallery ---
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = post.content;
                        const imagesInContent = Array.from(tempDiv.querySelectorAll('img')).map(img => img.src);
                        let imageGalleryHTML = '';
                        if (imagesInContent.length > 0) {
                            imageGalleryHTML = `
                                <h3 class="text-2xl font-bold mt-12 mb-4">Post Images</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    ${imagesInContent.map(src => `
                                        <img src="${src}" @click="$dispatch('open-lightbox', { image: '${src}' })" alt="Post image" class="rounded-xl cursor-pointer hover:opacity-80 transition-opacity object-cover">
                                    `).join('')}
                                </div>`;
                        }

                        // --- 3. Prepare Social Share Links ---
                        const pageUrl = encodeURIComponent(window.location.href);
                        const pageTitle = encodeURIComponent(post.title);
                        
                        // --- 4. Render Final HTML ---
                        postContainer.innerHTML = `
                            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight brand-gradient-text">${post.title}</h1>
                            <p class="text-[var(--text-secondary)] mt-4 mb-8">Published on ${post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                            
                            ${post.imageUrl ? `<img src="assets/blog/${post.imageUrl}" alt="Main post image" class="w-full rounded-2xl mb-8 object-cover">` : ''}
                            
                            <div class="post-content text-lg">${post.content}</div>

                            ${imageGalleryHTML}

                            <div class="mt-12 pt-8 border-t border-[var(--border-color)]">
                                <h3 class="text-xl font-bold text-center mb-4">Share this Post</h3>
                                <div class="flex justify-center items-center gap-4">
                                    <a href="https://www.facebook.com/sharer/sharer.php?u=${pageUrl}" target="_blank" class="flex items-center justify-center w-12 h-12 glass-effect rounded-full hover:border-blue-600 transition-all" title="Share on Facebook"><svg class="w-6 h-6 text-[#1877F2]" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/></svg></a>
                                    <a href="https://twitter.com/intent/tweet?url=${pageUrl}&text=${pageTitle}" target="_blank" class="flex items-center justify-center w-12 h-12 glass-effect rounded-full hover:border-gray-400 transition-all" title="Share on X"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16"><path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/></svg></a>
                                    <a href="https://api.whatsapp.com/send?text=${pageTitle}%20${pageUrl}" target="_blank" class="flex items-center justify-center w-12 h-12 glass-effect rounded-full hover:border-green-500 transition-all" title="Share on WhatsApp"><svg class="w-6 h-6 text-[#25D366]" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.919 6.066l-1.479 5.414 5.532-1.441z"/></svg></a>
                                </div>
                            </div>
                        `;
                    } else {
                        postContainer.innerHTML = `<p class="text-center text-red-500">Post not found. It may have been removed.</p>`;
                    }
                } catch (error) {
                    console.error("Error fetching post details: ", error);
                    postContainer.innerHTML = `<p class="text-center text-red-500">Error loading post. Please try again later.</p>`;
                }
            }
            
            fetchPostDetails();

            // Light/dark mode logic
            const themeToggle = document.getElementById('theme-toggle');
            const applyTheme = (theme) => {
                document.documentElement.className = theme;
                document.getElementById('theme-icon-light').classList.toggle('hidden', theme === 'dark');
                document.getElementById('theme-icon-dark').classList.toggle('hidden', theme !== 'dark');
            };
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.className === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        });
    </script>
</body>
</html>