<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Blog</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root { --bg-color: #030712; --text-color: #f3f4f6; --text-secondary: #9ca3af; --card-bg: rgba(31, 41, 55, 0.5); --border-color: rgba(55, 65, 81, 0.6); --input-bg: #1f2937; --input-border: #4b5563; }
        html.light { --bg-color: #f9fafb; --text-color: #111827; --text-secondary: #4b5563; --card-bg: rgba(255, 255, 255, 0.7); --border-color: #e5e7eb; --input-bg: #f3f4f6; --input-border: #d1d5db; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .glass-effect { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border-color); }
        .form-input { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-color); }
        .form-input:focus { border-color: #3B82F6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        /* Quill Editor Styling */
        #editor-container { background-color: var(--input-bg); color: var(--text-color); border-radius: 0 0 0.5rem 0.5rem; }
        .ql-toolbar { background-color: var(--input-bg); border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; border-bottom: 1px solid var(--border-color) !important; }
        .ql-toolbar .ql-stroke { stroke: var(--text-secondary); }
        .ql-toolbar .ql-fill { fill: var(--text-secondary); }
        .ql-toolbar .ql-picker-label { color: var(--text-secondary); }
        .ql-container.ql-snow { border: 1px solid var(--input-border) !important; border-radius: 0.5rem; }
        .ql-editor { color: var(--text-color); }
        .ql-editor.ql-blank::before { color: var(--text-secondary); }
    </style>
</head>
<body class="w-full">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm glass-effect p-8 rounded-2xl">
            <h1 class="text-2xl font-bold text-center mb-1">Admin Login</h1>
            <p class="text-center text-[var(--text-secondary)] mb-6">Access your blog dashboard</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" required class="form-input w-full p-3 rounded-lg">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" required class="form-input w-full p-3 rounded-lg">
                </div>
                <p id="login-error" class="text-red-500 text-sm hidden"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 transition-transform hover:scale-105">Login</button>
            </form>
        </div>
    </div>

    <!-- ADMIN DASHBOARD (Initially hidden) -->
    <div id="admin-dashboard" class="hidden">
        <header class="sticky top-0 left-0 w-full z-50 glass-effect">
            <div class="container mx-auto px-5 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">Admin Panel</h1>
                <button id="logout-btn" class="bg-red-600 text-white font-semibold text-sm py-2 px-4 rounded-full hover:bg-red-700">Logout</button>
            </div>
        </header>

        <main class="container mx-auto px-5 py-8">
            <section id="post-form-section" class="mb-12">
                <h2 class="text-3xl font-bold mb-6" id="form-title">Create New Post</h2>
                <form id="post-form" class="glass-effect p-6 rounded-2xl space-y-6">
                    <input type="hidden" id="post-id">
                    <div>
                        <label for="post-title" class="block text-sm font-medium mb-1">Post Title</label>
                        <input type="text" id="post-title" required class="form-input w-full p-3 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Post Content</label>
                        <!-- Quill Editor Container -->
                        <div id="editor-container" class="h-64"></div>
                    </div>
                    <div>
                        <label for="post-image" class="block text-sm font-medium mb-1">Main Image Filename</label>
                        <input type="text" id="post-image" required class="form-input w-full p-3 rounded-lg" placeholder="e.g., my-awesome-post.jpg">
                        <p class="text-xs text-[var(--text-secondary)] mt-1">Upload this file to the `assets/blog/` folder.</p>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700">Save Post</button>
                        <button type="button" id="cancel-edit-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-full hover:bg-gray-700 hidden">Cancel Edit</button>
                    </div>
                </form>
            </section>

            <section id="manage-posts-section">
                <h2 class="text-3xl font-bold mb-6">Manage Posts</h2>
                <div id="existing-posts-container" class="space-y-4"></div>
            </section>
        </main>
    </div>
    
    <!-- Firebase SDK (using modules for better practice) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js" type="module"></script>
    
    <!-- Quill Rich Text Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBO54U5WtwR3rfDDHFgDbPzwF-V27Ml5m4",
            authDomain: "portfolio-87299.firebaseapp.com",
            projectId: "portfolio-87299",
            storageBucket: "portfolio-87299.firebasestorage.app",
            messagingSenderId: "458111444495",
            appId: "1:458111444495:web:f290b11f480e6ad1fe657a",
            measurementId: "G-6EYBX1VE63"
        };

        // Import functions from SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, deleteDoc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- QUILL EDITOR SETUP ---
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'link'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const postForm = document.getElementById('post-form');
        const postsContainer = document.getElementById('existing-posts-container');
        const formTitle = document.getElementById('form-title');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginScreen.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                fetchPostsForAdmin();
            } else {
                loginScreen.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginError.classList.add('hidden');
            } catch (error) {
                loginError.textContent = "Error: Invalid credentials or connection issue.";
                loginError.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- FIRESTORE CRUD ---
        async function fetchPostsForAdmin() {
            const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(postsQuery);
            postsContainer.innerHTML = ''; // Clear existing
            querySnapshot.forEach(doc => {
                const post = doc.data();
                const postEl = document.createElement('div');
                postEl.className = 'glass-effect p-4 rounded-xl flex justify-between items-center';
                postEl.innerHTML = `
                    <div>
                        <h4 class="font-bold">${post.title}</h4>
                        <p class="text-sm text-[var(--text-secondary)]">${new Date(post.timestamp.seconds * 1000).toLocaleDateString()}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-btn bg-yellow-600 text-white font-semibold text-xs py-1 px-3 rounded-full" data-id="${doc.id}">Edit</button>
                        <button class="delete-btn bg-red-600 text-white font-semibold text-xs py-1 px-3 rounded-full" data-id="${doc.id}">Delete</button>
                    </div>
                `;
                postsContainer.appendChild(postEl);
            });
        }
        
        // Add or Update Post
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value;
            const imageUrl = document.getElementById('post-image').value;
            // Get HTML content from Quill
            const content = quill.root.innerHTML;

            if (title.trim() === '' || quill.getLength() <= 1) {
                alert('Please fill out the title and content.');
                return;
            }

            const postData = { title, content, imageUrl };
            
            try {
                if (postId) { // Update existing post
                    const docRef = doc(db, "posts", postId);
                    await updateDoc(docRef, postData);
                    alert('Post updated successfully!');
                } else { // Add new post
                    postData.timestamp = serverTimestamp();
                    await addDoc(collection(db, "posts"), postData);
                    alert('Post created successfully!');
                }
                resetFormState();
                fetchPostsForAdmin();
            } catch (error) {
                console.error("Error saving post:", error);
                alert('Error saving post.');
            }
        });

        // Event Delegation for Edit/Delete
        postsContainer.addEventListener('click', async (e) => {
            const target = e.target;
            const postId = target.dataset.id;

            if (target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this post?')) {
                    await deleteDoc(doc(db, "posts", postId));
                    fetchPostsForAdmin();
                }
            }
            
            if (target.classList.contains('edit-btn')) {
                const docRef = doc(db, "posts", postId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const postData = docSnap.data();
                    formTitle.textContent = "Edit Post";
                    document.getElementById('post-id').value = postId;
                    document.getElementById('post-title').value = postData.title;
                    document.getElementById('post-image').value = postData.imageUrl;
                    // Set Quill's content
                    quill.root.innerHTML = postData.content;
                    
                    cancelEditBtn.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });
        
        // Cancel Edit Function
        function resetFormState() {
            formTitle.textContent = "Create New Post";
            postForm.reset();
            quill.root.innerHTML = ''; // Clear the editor
            document.getElementById('post-id').value = '';
            cancelEditBtn.classList.add('hidden');
        }
        cancelEditBtn.addEventListener('click', resetFormState);

    </script>
</body>
</html>